<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"
    />
    <title>Profile</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Reset & Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: #fff;
        color: #333;
        line-height: 1.6;
      }
      a {
        text-decoration: none;
      }

      /* Optional Navbar */
      .navbar {
        display: flex;
        justify-content: center;
        background-color: #ffbfd7;
        padding: 10px 0;
      }
      .navbar ul {
        list-style: none;
        display: flex;
      }
      .navbar ul li {
        margin: 0 15px;
      }
      .navbar ul li a {
        color: #fff;
        font-weight: bold;
        padding: 8px 12px;
        transition: background-color 0.3s;
      }
      .navbar ul li a:hover {
        background-color: #d69bb3;
        border-radius: 4px;
      }

      /* Container */
      .container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
      }

      /* Profile Section */
      .profile-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
        text-align: center;
      }
      .profile-image {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #ffbfd7;
        margin-bottom: 20px;
      }
      .profile-name {
        font-size: 2rem;
        margin-bottom: 10px;
      }
      .profile-description {
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: #666;
      }
      .profile-link {
        font-size: 1rem;
        margin-bottom: 20px;
        color: #ffbfd7;
        text-decoration: underline;
      }
      .profile-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }
      .btn {
        background-color: #ffbfd7;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .btn:hover {
        background-color: #d69bb3;
      }

      /* Content Section (Cards Gallery) */
      .content-section {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        padding: 20px;
      }
      .card {
        background-color: #f5f5f5;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        position: relative;
        transition: transform 0.3s;
        cursor: pointer;
      }
      .card:hover {
        transform: translateY(-5px);
      }
      .card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .card h3 {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        font-size: 1rem;
      }
      .add-card {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f0f0;
        border: 2px dashed #ccc;
        border-radius: 10px;
        font-size: 3rem;
        color: #aaa;
        cursor: pointer;
        transition: background-color 0.3s;
        height: 220px;
      }
      .add-card:hover {
        background-color: #eaeaea;
      }

      /* Modal Popup Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.5);
        padding: 20px;
      }
      .modal-content {
        background: #fff;
        margin: 50px auto;
        padding: 30px;
        border-radius: 10px;
        max-width: 600px;
        position: relative;
      }
      .close-btn {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 1.5rem;
        color: #333;
        cursor: pointer;
      }
      .modal-content h2 {
        margin-bottom: 20px;
        color: #ffbfd7;
      }
      .modal-content label {
        display: block;
        margin: 10px 0 5px;
      }
      .modal-content input[type="text"],
      .modal-content textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .image-upload-container,
      .media-upload-container {
        margin: 20px 0;
        padding: 20px;
        border: 2px dashed #ccc;
        text-align: center;
        cursor: pointer;
        border-radius: 10px;
        transition: background-color 0.3s;
      }
      .image-upload-container:hover,
      .media-upload-container:hover {
        background-color: #f8f8f8;
      }
      .saveCard {
        background-color: #ffbfd7;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 1rem;
        transition: background-color 0.3s;
      }
      .saveCard:hover {
        background-color: #d69bb3;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .profile-section {
          padding: 20px;
        }
        .profile-name {
          font-size: 1.8rem;
        }
        .profile-description {
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Profile Section -->
      <section class="profile-section">
        <img src="" class="profile-image" />
        <h1 class="profile-name"></h1>
        <p class="profile-description"></p>
        <a href="#" class="profile-link"></a>
        <div class="profile-buttons">
          <button
            id="editButton"
            class="btn"
            style="visibility: hidden"
            onclick="window.location.href='getstarted.html'"
          >
            Edit
          </button>
          <button id="logoutButton" class="btn" style="visibility: hidden">
            Logout
          </button>
        </div>
      </section>

      <!-- Content Section (Cards Gallery) -->
      <section class="content-section" id="card-container">
        <!-- Cards will be inserted dynamically -->
        <div
          class="add-card"
          id="add-card-cardContainer"
          style="visibility: hidden"
        >
          +
        </div>
      </section>
    </div>

    <!-- Card Click Popup Modal -->
    <div id="cardClickPopup" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="close-cardClickPopup-button">&times;</span>
        <img
          id="cardClickPopup-cardImage"
          src=""
          alt="Card Image"
          style="width: 100%; border-radius: 10px"
        />
        <h2 id="cardClickPopup-cardTitle">Title</h2>
        <p id="cardClickPopup-cardDescription">Description</p>
        <div id="youtube-container"></div>
        <div style="margin-top: 20px">
          <button id="verify-cardClickPopup-button" class="btn">Copy</button>
          <button
            id="delete-cardClickPopup-button"
            class="btn"
            style="visibility: hidden"
          >
            Delete
          </button>
          <button id="src-cardClickPopup-button" class="btn">Source</button>
        </div>
      </div>
    </div>

    <!-- Card Popup Modal (Add New Card) -->
    <div id="cardPopup" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="close-cardPopup-button">&times;</span>
        <h2>Add New Image</h2>
        <label for="cardTitle">Title</label>
        <input type="text" id="cardTitle" placeholder="Title" />
        <label for="cardDescription">Describe your image</label>
        <textarea
          id="cardDescription"
          placeholder="Description"
          rows="4"
        ></textarea>
        <label for="imageInput">Upload Image</label>
        <div id="imageUploadContainer" class="image-upload-container">
          <span>Click to upload image</span>
          <img
            id="previewImage"
            style="
              display: none;
              max-width: 100%;
              max-height: 200px;
              margin-top: 10px;
            "
          />
          <input
            type="file"
            id="imageInput"
            accept="image/*"
            style="display: none"
          />
        </div>
        <label for="cardlinkevidence">
          YouTube Link (evidence of creation)
        </label>
        <input type="text" id="cardlinkevidence" placeholder="YouTube link" />
        <button class="saveCard" id="saveCard">Save</button>
      </div>
    </div>

    <!-- Scripts (Same as your original functionality code) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        setPersistence,
        browserLocalPersistence,
        createUserWithEmailAndPassword,
        signOut,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        arrayUnion,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytesResumable,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAQ3sc83x5CcAXW9NTt-NJUcT6C1Zzk6Fc",
        authDomain: "artify-22dff.firebaseapp.com",
        projectId: "artify-22dff",
        storageBucket: "artify-22dff.appspot.com",
        messagingSenderId: "287489070433",
        appId: "1:287489070433:web:83767829fbbb878168e120",
        measurementId: "G-TVHZLDMK8L",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
      let username = null;
      let description = null;
      let profileImage = null;
      let link = null;
      let uid = null;
      const params = new URLSearchParams(window.location.search);
      const incomingId = params.get("key");
      let postIds = [];
      let currentPostId = null;

      // Close popup when clicking outside modal content
      document
        .getElementById("cardClickPopup")
        .addEventListener("click", function (event) {
          if (event.target.id === "cardClickPopup") {
            hidePopup();
            clearPopupFields();
          }
        });

      document
        .getElementById("verify-cardClickPopup-button")
        .addEventListener("click", function () {
          copyTextToClipboard(
            `https://goliadsearch.com/?post=${currentPostId}`
          );
          document.getElementById("verify-cardClickPopup-button").textContent =
            "Copied";
        });

      document
        .getElementById("logoutButton")
        .addEventListener("click", function () {
          signOut(auth)
            .then(() => {
              window.location.href = "index.html";
            })
            .catch((error) => {
              console.log(error);
            });
        });

      document
        .getElementById("imageUploadContainer")
        .addEventListener("click", function () {
          document.getElementById("imageInput").click();
        });

      document
        .getElementById("imageInput")
        .addEventListener("change", function (event) {
          if (event.target.files && event.target.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
              document.getElementById("previewImage").src = e.target.result;
              document.getElementById("previewImage").style.display = "block";
            };

            reader.readAsDataURL(event.target.files[0]);
          }
        });

      document
        .getElementById("add-card-cardContainer")
        .addEventListener("click", function () {
          document.getElementById("cardPopup").style.display = "block";
        });

      document
        .getElementById("close-cardPopup-button")
        .addEventListener("click", function () {
          document.getElementById("cardPopup").style.display = "none";
          document.getElementById("previewImage").style.display = "none";
          document.getElementById("previewImage").src = "";
        });

      document
        .getElementById("saveCard")
        .addEventListener("click", function () {
          const title = document.getElementById("cardTitle").value;
          const postDescription =
            document.getElementById("cardDescription").value;
          const imageFile = document.getElementById("imageInput").files[0];
          const cardlinkevidence =
            document.getElementById("cardlinkevidence").value;

          if (
            !title.trim() ||
            !postDescription.trim() ||
            !imageFile ||
            !cardlinkevidence.trim()
          ) {
            alert("Please fill all fields and select at least one file.");
            return;
          }
          let formInformation = {
            title: title,
            description: postDescription,
            uid: uid,
            username: username,
            verified: false,
            timestamp: Date.now(),
            cardlinkevidence: cardlinkevidence ? cardlinkevidence : "null",
            source: null,
          };

          let userInformation = {
            username: username,
            profileImage: profileImage,
            description: description,
            link: link,
            posts: postIds,
          };

          uploadBytesResumable(
            ref(storage, "images/" + imageFile.name),
            imageFile
          )
            .then((snapshot) => {
              getDownloadURL(snapshot.ref).then((url) => {
                formInformation.Image = url;
                formInformation.media_url = "null";

                addDoc(collection(db, "database"), formInformation)
                  .then((docRef) => {
                    userInformation.posts.push(docRef.id);
                    setDoc(doc(db, "artist", uid), userInformation)
                      .then(() => {
                        addCard(
                          formInformation.title,
                          formInformation.Image,
                          docRef.id
                        );
                        document.getElementById("cardPopup").style.display =
                          "none";
                        clearPopupFields();
                      })
                      .catch((error) => {
                        console.error("Upload failed", error);
                      });
                  })
                  .catch((error) => {
                    console.error("Upload failed", error);
                  });
              });
            })
            .catch((error) => {
              console.error("Upload failed", error);
            });
        });

      document
        .getElementById("close-cardClickPopup-button")
        .addEventListener("click", function () {
          currentPostId = null;
          hidePopup();
        });

      document
        .getElementById("delete-cardClickPopup-button")
        .addEventListener("click", function () {
          let userInformation = {};
          postIds = postIds.filter((item) => item !== currentPostId);
          userInformation.username = username;
          userInformation.profileImage = profileImage;
          userInformation.description = description;
          userInformation.link = link;
          userInformation.posts = postIds;
          const docRef = doc(db, "database", currentPostId);
          deleteDoc(docRef)
            .then(() => {
              setDoc(doc(db, "artist", uid), userInformation).catch((error) => {
                console.error("Upload failed", error);
              });

              const cardContainer = document.getElementById("card-container");
              const cardToRemove = cardContainer.querySelector(
                `div[postid="${currentPostId}"]`
              );

              if (cardContainer && cardToRemove) {
                cardContainer.removeChild(cardToRemove);
              } else {
                console.log("Element not found");
              }
            })
            .catch((error) => {
              console.error("Upload failed", error);
            });
          hidePopup();
        });

      function hidePopup() {
        document.getElementById("cardClickPopup").style.display = "none";
        document.getElementById("youtube-container").innerHTML = "";
        document.getElementById("cardClickPopup-cardImage").src = "";
        document.getElementById("cardClickPopup-cardTitle").textContent = "";
        document.getElementById("cardClickPopup-cardDescription").textContent =
          "";
      }

      function showPopup(postId) {
        currentPostId = postId;
        document.getElementById("cardClickPopup").style.display = "block";
        const cardTitle = document.getElementById("cardClickPopup-cardTitle");
        const cardDescription = document.getElementById(
          "cardClickPopup-cardDescription"
        );
        const cardImage = document.getElementById("cardClickPopup-cardImage");
        const docRef = doc(db, "database", postId);
        getDoc(docRef).then((docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            let title = data.title;
            let image = data.Image;
            let description = data.description;
            if (data.cardlinkevidence) {
              loadVideo(data.cardlinkevidence);
            }
            cardImage.src = image;
            cardTitle.textContent = title;
            cardDescription.textContent = description;
            if (!data.verified) {
              document.getElementById(
                "verify-cardClickPopup-button"
              ).style.display = "none";
            } else {
              document.getElementById(
                "verify-cardClickPopup-button"
              ).style.display = "inline-block";
            }
          }
        });
      }

      function addCard(title, imageSrc, postid, isVerified) {
        const cardContainer = document.getElementById("card-container");
        const newCard = document.createElement("div");
        newCard.classList.add("card");
        newCard.setAttribute("postid", postid);

        const imgElement = document.createElement("img");
        imgElement.src = imageSrc;
        newCard.appendChild(imgElement);

        const titleElement = document.createElement("h3");
        titleElement.textContent = title;
        if (!isVerified) {
          titleElement.textContent = "Verification in progress";
        }
        newCard.appendChild(titleElement);
        newCard.addEventListener("click", function () {
          showPopup(postid);
        });
        const addCardDiv = document.getElementById("add-card-cardContainer");
        cardContainer.insertBefore(newCard, addCardDiv);
      }

      function clearPopupFields() {
        document.getElementById("cardTitle").value = "";
        document.getElementById("cardDescription").value = "";
        document.getElementById("previewImage").style.display = "none";
        document.getElementById("previewImage").src = "";
        document.getElementById("verify-cardClickPopup-button").textContent =
          "Copy";
      }

      function populateCardContainer() {
        for (const post of postIds) {
          const postRef = doc(db, "database", post);
          getDoc(postRef)
            .then((docSnap) => {
              if (docSnap.exists()) {
                const postData = docSnap.data();
                let title = postData.title;
                let image = postData.Image;
                let isVerified = postData.verified;
                if (incomingId == null || (incomingId != null && isVerified)) {
                  addCard(title, image, post, isVerified);
                }
              }
            })
            .catch((error) => {
              console.log("Error getting document:", error);
            });
        }
      }

      auth.onAuthStateChanged(function (user) {
        if (incomingId == null) {
          if (user) {
            document.getElementById("editButton").style.visibility = "visible";
            document.getElementById("logoutButton").style.visibility =
              "visible";
            document.getElementById("add-card-cardContainer").style.visibility =
              "visible";
            uid = user.uid;
            const docRef = doc(db, "artist", uid);
            getDoc(docRef)
              .then((docSnap) => {
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  username = data.username;
                  description = data.description;
                  profileImage = data.profileImage;
                  link = data.link;
                  postIds = data.posts;

                  fetch(data.profileImage)
                    .then((response) => response.blob())
                    .then((blob) => {
                      const imageUrl = URL.createObjectURL(blob);
                      document.querySelector(".profile-image").src = imageUrl;
                    })
                    .catch((error) => {
                      console.error("Error downloading profile image:", error);
                    });
                  document.querySelector(".profile-name").innerText =
                    data.username;
                  document.querySelector(".profile-description").innerText =
                    data.description;
                  document.querySelector(".profile-link").innerText = data.link;
                  populateCardContainer();
                } else {
                  alert("You have not created a profile yet");
                }
              })
              .catch((error) => {
                console.log("Error getting document:", error);
              });
          } else {
            console.log("You are not logged in");
          }
        } else {
          const docRef = doc(db, "artist", incomingId);
          getDoc(docRef)
            .then((docSnap) => {
              if (docSnap.exists()) {
                const data = docSnap.data();
                username = data.username;
                description = data.description;
                profileImage = data.profileImage;
                link = data.link;
                postIds = data.posts;

                fetch(data.profileImage)
                  .then((response) => response.blob())
                  .then((blob) => {
                    const imageUrl = URL.createObjectURL(blob);
                    document.querySelector(".profile-image").src = imageUrl;
                  })
                  .catch((error) => {
                    console.error("Error downloading profile image:", error);
                  });
                document.querySelector(".profile-name").innerText =
                  data.username;
                document.querySelector(".profile-description").innerText =
                  data.description;
                document.querySelector(".profile-link").innerText = data.link;
                populateCardContainer();
              } else {
                alert("You have not created a profile yet");
              }
            })
            .catch((error) => {
              console.log("Error getting document:", error);
            });
        }
      });

      function copyTextToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            console.log("Text copied to clipboard successfully!", text);
          })
          .catch((err) => {
            console.error("Failed to copy text: ", err);
          });
      }
      function loadVideo(url) {
        const urlParams = new URL(url).searchParams;
        const videoId = urlParams.get("v");
        const iframe = document.createElement("iframe");
        iframe.width = "560";
        iframe.height = "315";
        iframe.src = `https://www.youtube.com/embed/${videoId}`;
        iframe.frameBorder = "0";
        iframe.allowFullscreen = true;
        document.getElementById("youtube-container").appendChild(iframe);
      }
    </script>
  </body>
</html>
