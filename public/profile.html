<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1,
    maximum-scale=1.0, user-scalable=no"
    />
    <title>Profile</title>
    <style>
      body {
        flex-direction: row; /* Ensures horizontal layout */
        align-items: flex-start; /* Align items to the top */
        justify-content: center; /* Center items horizontally */
        height: 100vh;

        box-sizing: border-box;
        width: 100vw; /* Ensure the body covers the full viewport width */
        margin: 0; /* Reset any default margins */
        padding: 0; /* Reset any default padding */
      }
      .navbar {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #ffbfd7; /* Dark background */
      }

      .navbar li {
        float: left; /* Align items horizontally */
      }

      .navbar li a {
        display: block;
        color: white; /* Text color */
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
      }

      .navbar li a:hover {
        background-color: #111; /* Change color on hover */
      }

      .profile-container {
        flex-basis: 33.33%; /* Allocate 1/3 of the parent container's width */
        height: 100%; /* Take full height of the viewport */
        overflow: auto; /* Enable scrolling if content overflows */
        display: flex; /* Enable flexbox */
        box-sizing: border-box;
        flex-direction: column; /* Stack children vertically */
        justify-content: center; /* Center children vertically */
        align-items: center; /* Center children horizontally */
        width: 100%;
      }
      .card {
        width: 200px;
        height: 200px;
        background-color: lightgray;
        margin-bottom: 0px;
        border-radius: 10px;
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.173);
        overflow: hidden;
      }

      .card-container {
        display: grid;
        justify-content: center; /* Centers the grid items */
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px; /* Adjust the space between cards */
        margin: 10em auto; /* Center the container with auto left and right margins */
        padding: 0 10px; /* Add padding inside the container if needed */
        width: auto; /* Adjust based on your layout's needs */
        max-width: 100%; /* Ensure the container does not overflow the viewport width */
        overflow-x: hidden; /* Prevent horizontal scrollbar */
        overflow-y: auto; /* Allow vertical scrolling if necessary */
      }
      .profile-container,
      .card-container {
        margin-top: 50px; /* Adjust as needed */
      }

      .profile-container {
        /* Ensure both containers can scroll independently if content overflows */
        overflow: auto;
        height: 100%;
        width: 100%; /* Take full height of the viewport */
      }

      .profile-image {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #dddddd;
      }

      .profile-name {
        font-size: 24px;
        font-weight: bold;
        margin-top: 10px;
      }

      .profile-description {
        font-size: 18px;
        margin: 10px;
        text-align: center;
      }

      .profile-link {
        font-size: 18px;
        margin: 10px;
        text-align: center;
      }
      .card,
      .add-card {
        border-radius: 4px;
      }

      .edit-button {
        margin-top: 10px;
      }

      .post-button {
        margin-top: 10px;
      }

      .add-card {
        width: 200px;
        height: 200px;
        background-color: #f0f0f0; /* Light grey, adjust as needed */
        display: flex;
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.173);
        border-radius: 10px;
        justify-content: center;
        align-items: center;
        font-size: 24px; /* Large plus sign */
        cursor: pointer;
      }
      .card-popup {
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;

        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0, 0, 0); /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
      }
      .card-click-popup {
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0, 0, 0); /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
      }

      .popup-content {
        background-color: #fefefe;
        margin: 5% auto; /* 15% from the top and centered */
        padding: 50px;

        border-radius: 10px;
        border: 1px solid #888;
        width: 50%; /* Could be more or less, depending on screen size */
      }

      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .content-container {
        grid-template-columns: 1fr 2fr; /* Adjust the ratio as needed */

        display: flex;
        flex-direction: row; /* Default layout for larger screens */
      }
      .image-upload-container {
        margin: 20px 0;
        padding: 10px;
        border: 2px dashed #ccc;
        text-align: center;
        cursor: pointer;
      }

      .saveCard {
        width: 10%;
        padding: 10px;
        border: none;
        margin-bottom: 10px;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ffbfd7;
        color: white;
        cursor: pointer;
      }

      .image-upload-container:hover {
        background-color: #f8f8f8;
      }

      .media-upload-container {
        margin: 20px 0;
        padding: 10px;
        border: 2px dashed #ccc;
        text-align: center;
        cursor: pointer;
      }

      .media-upload-container:hover {
        background-color: #f8f8f8;
      }

      .logout-button {
        width: 25%;
        padding: 10px;
        border: none;
        margin-bottom: 10px;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ffbfd7;
        color: white;
        cursor: pointer;
      }

      .edit-button {
        width: 25%;
        padding: 10px;
        border: none;
        margin-bottom: 10px;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ffbfd7;
        color: white;
        cursor: pointer;
      }
      .greyed-out {
        filter: grayscale(100%);
      }
      #delete-cardClickPopup-button {
        width: 10%;
        padding: 10px;
        border: none;
        margin-bottom: 10px;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ffbfd7;
        color: white;
        cursor: pointer;
      }
      #close-cardClickPopup-button {
        width: 10%;
        padding: 10px;
        border: none;
        margin-bottom: 10px;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ffbfd7;
        color: white;
        cursor: pointer;
      }
      @media (max-width: 600px) {
        .content-container {
          width: 100%;
          flex-direction: column; /* Stack vertically on smaller screens */
        }
        .card-container {
          grid-template-columns: repeat(
            auto-fit,
            minmax(150px, 1fr)
          ); /* smaller min-width for cards */

          .card {
            width: 175px;
            height: 175px; /* full width on small screens */
          }

          .add-card {
            width: 175px;
            height: 175px;
          }
        }
        #close-cardClickPopup-button,
        #src-cardClickPopup-button {
          width: 100%;
        }
        body {
          padding: 0;
          margin: 0;
          width: 100vw; /* This ensures they don't extend past the viewport width */
          overflow-x: hidden; /* Prevents horizontal scrolling */
        }

        .profile-container,
        .card-container {
          /* Adjust padding and margin as needed to fit the content */
          padding: 5px;
          margin-top: 0;
        }

        .card,
        .add-card {
          margin: 5% auto; /* Centering cards */
        }

        /* Optional: Adjust profile and card container styles for mobile */
        .profile-container,
        .card-container {
          width: 100%; /* Use the full width */
          margin-top: 0; /* Reset or adjust spacing as needed */
        }
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="cardClickPopup" class="card-click-popup" style="display: none">
      <div class="popup-content">
        <img id="cardClickPopup-cardImage" />
        <h2 id="cardClickPopup-cardTitle">Title</h2>
        <h2 id="cardClickPopup-cardDescription">description</h2>

        <button id="close-cardClickPopup-button">exit</button>
        <button id="delete-cardClickPopup-button" style="visibility: hidden">
          delete
        </button>
      </div>
    </div>
    <div id="cardPopup" class="card-popup" style="display: none">
      <div class="popup-content">
        <span class="close-button">&times;</span>
        <h2>Add New Image</h2>

        <!-- Title Input -->
        <label for="cardTitle">Title</label>
        <input
          type="text"
          id="cardTitle"
          placeholder="Title"
          style="width: 100%; padding: 8px; margin-bottom: 10px"
        />

        <!-- Description Input -->
        <label for="cardDescription">Describe your image</label>
        <textarea
          id="cardDescription"
          placeholder="Description"
          style="width: 100%; padding: 8px; margin-bottom: 10px"
          rows="4"
        ></textarea>

        <!-- Image Upload -->
        <label for="imageInput">Upload Image</label>
        <div id="imageUploadContainer" class="image-upload-container">
          <span>Click to upload image</span>
          <img
            id="previewImage"
            style="display: none; max-width: 100%; max-height: 200px"
          />
          <input
            type="file"
            id="imageInput"
            accept="image/*"
            style="display: none"
          />
        </div>

        <!-- Media Upload -->
        <label for="mediaInput"
          >Upload Video/Image Evidence of Creation Process</label
        >
        <div id="mediaUploadContainer" class="media-upload-container">
          <span>Click to upload video/image evidence of creation process</span>
          <input
            type="file"
            id="mediaInput"
            accept="image/*,video/*,audio/*,text/plain"
            style="display: none"
          />
        </div>

        <!-- Link Evidence Input -->
        <label for="cardlinkevidence"
          >OR Link Evidence of Creation Process</label
        >
        <input
          type="text"
          id="cardlinkevidence"
          placeholder="link evidence of creation process"
          style="width: 100%; padding: 8px; margin-bottom: 10px"
        />

        <button class="saveCard" id="saveCard">Save</button>
      </div>
    </div>
    <div class="content-container">
      <div class="profile-container">
        <img class="profile-image" />
        <h1 class="profile-name"></h1>
        <p class="profile-description"></p>
        <p class="profile-link"></p>
        <button
          class="edit-button"
          style="visibility: hidden"
          id="editButton"
          onclick="window.location.href='getstarted.html'"
        >
          Edit
        </button>
        <button
          style="visibility: hidden"
          id="logoutButton"
          class="logout-button"
        >
          Logout
        </button>
      </div>

      <div id="card-container" class="card-container">
        <!-- Add your card elements here -->
        <div
          class="add-card"
          id="add-card-cardContainer"
          style="visibility: hidden"
        >
          +
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        setPersistence,
        browserLocalPersistence,
        createUserWithEmailAndPassword,
        signOut,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        arrayUnion,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytesResumable,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAQ3sc83x5CcAXW9NTt-NJUcT6C1Zzk6Fc",
        authDomain: "artify-22dff.firebaseapp.com",
        projectId: "artify-22dff",
        storageBucket: "artify-22dff.appspot.com",
        messagingSenderId: "287489070433",
        appId: "1:287489070433:web:83767829fbbb878168e120",
        measurementId: "G-TVHZLDMK8L",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
      let username = null;
      let description = null;
      let profileImage = null;
      let link = null;
      let uid = null;
      const params = new URLSearchParams(window.location.search);
      const incomingId = params.get("key");
      let postIds = [];
      let currentPostId = null;
      document
        .getElementById("cardClickPopup")
        .addEventListener("click", function () {
          hidePopup();
        });
      document
        .getElementById("logoutButton")
        .addEventListener("click", function () {
          signOut(auth)
            .then(() => {
              window.location.href = "index.html";
            })
            .catch((error) => {
              console.log(error);
            });
        });
      document
        .getElementById("mediaUploadContainer")
        .addEventListener("click", function () {
          document.getElementById("mediaInput").click();
        });

      document
        .getElementById("mediaInput")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            // Check file size
            const fileSizeMB = file.size / 1024 / 1024; // Size in MB
            if (fileSizeMB > 300) {
              alert(
                "File size exceeds 300 MB limit. Please choose a smaller file."
              );
              return; // Stop further execution
            }
          }
        });
      document
        .getElementById("imageUploadContainer")
        .addEventListener("click", function () {
          document.getElementById("imageInput").click();
        });

      document
        .getElementById("imageInput")
        .addEventListener("change", function (event) {
          if (event.target.files && event.target.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
              document.getElementById("previewImage").src = e.target.result;
              document.getElementById("previewImage").style.display = "block";
            };

            reader.readAsDataURL(event.target.files[0]);
          }
        });

      document
        .querySelector(".add-card")
        .addEventListener("click", function () {
          document.getElementById("cardPopup").style.display = "block";
        });

      document
        .querySelector(".close-button")
        .addEventListener("click", function () {
          document.getElementById("cardPopup").style.display = "none";
          document.getElementById("previewImage").style.display = "none"; // Hide image preview when closing popup
          document.getElementById("previewImage").src = ""; // Remove the src to clear the preview
        });

      document
        .getElementById("saveCard")
        .addEventListener("click", function () {
          const title = document.getElementById("cardTitle").value;
          const postDescription =
            document.getElementById("cardDescription").value;
          const imageFile = document.getElementById("imageInput").files[0];
          const mediaFile = document.getElementById("mediaInput").files[0];
          const cardlinkevidence =
            document.getElementById("cardlinkevidence").value;

          // Validate fields are not empty and at least one file is selected
          if (
            !title.trim() ||
            !description.trim() ||
            !imageFile ||
            (!mediaFile && !cardlinkevidence)
          ) {
            alert("Please fill all fields and select at least one file.");
            return;
          }
          let formInformation = {};
          formInformation.title = title;
          formInformation.description = postDescription;
          formInformation.uid = uid;
          formInformation.username = username;
          formInformation.verified = false;
          formInformation.timestamp = Date.now();
          if (cardlinkevidence != null) {
            formInformation.cardlinkevidence = cardlinkevidence;
          } else {
            formInformation.cardlinkevidence = "null";
          }

          let userInformation = {};
          userInformation.username = username;
          userInformation.profileImage = profileImage;
          userInformation.description = description;
          userInformation.link = link;
          userInformation.posts = postIds;

          // document.querySelector(".profile-name").innerText;
          uploadBytesResumable(
            ref(storage, "images/" + imageFile.name),
            imageFile
          )
            .then((snapshot) => {
              getDownloadURL(snapshot.ref).then((url) => {
                formInformation.Image = url;
                if (mediaFile != null) {
                  uploadBytesResumable(
                    ref(storage, "media/" + mediaFile.name),
                    mediaFile
                  )
                    .then((snapshot) => {
                      getDownloadURL(snapshot.ref).then((media_url) => {
                        formInformation.media_url = media_url;

                        addDoc(collection(db, "database"), formInformation)
                          .then((docRef) => {
                            userInformation.posts.push(docRef.id);
                            setDoc(doc(db, "artist", uid), userInformation)
                              .then(() => {
                                addCard(
                                  formInformation.title,
                                  formInformation.Image,
                                  docRef.id
                                );

                                document.getElementById(
                                  "cardPopup"
                                ).style.display = "none";
                                clearPopupFields();
                              })
                              .catch((error) => {
                                console.error("Upload failed", error);
                              });
                          })
                          .catch((error) => {
                            console.error("Upload failed", error);
                          });
                      });
                    })
                    .catch((error) => {
                      console.error("Upload failed", error);
                    });
                } else {
                  formInformation.media_url = "null";

                  addDoc(collection(db, "database"), formInformation)
                    .then((docRef) => {
                      userInformation.posts.push(docRef.id);
                      setDoc(doc(db, "artist", uid), userInformation)
                        .then(() => {
                          addCard(
                            formInformation.title,
                            formInformation.Image,
                            docRef.id
                          );

                          document.getElementById("cardPopup").style.display =
                            "none";
                          clearPopupFields();
                        })
                        .catch((error) => {
                          console.error("Upload failed", error);
                        });
                    })
                    .catch((error) => {
                      console.error("Upload failed", error);
                    });
                }
              });
            })
            .catch((error) => {
              console.error("Upload failed", error);
            });
        });

      document
        .getElementById("close-cardClickPopup-button")
        .addEventListener("click", function () {
          currentPostId = null;
          hidePopup();
        });

      document
        .getElementById("delete-cardClickPopup-button")
        .addEventListener("click", function () {
          let userInformation = {};
          postIds = postIds.filter((item) => item !== currentPostId);
          userInformation.username = username;
          userInformation.profileImage = profileImage;
          userInformation.description = description;
          userInformation.link = link;
          userInformation.posts = postIds;
          const docRef = doc(db, "database", currentPostId);
          deleteDoc(docRef)
            .then(() => {
              setDoc(doc(db, "artist", uid), userInformation).catch((error) => {
                console.error("Upload failed", error);
              });

              const cardContainer = document.getElementById("card-container");
              const cardToRemove = cardContainer.querySelector(
                `div[postid="${currentPostId}"]`
              );

              if (cardContainer && cardToRemove) {
                cardContainer.removeChild(cardToRemove);
              } else {
                console.log("Element not found");
              }
            })
            .catch((error) => {
              console.error("Upload failed", error);
            });

          hidePopup();
        });
      function hidePopup() {
        document.getElementById("cardClickPopup").style.display = "none";
      }

      function showPopup(postId) {
        currentPostId = postId;
        document.getElementById("cardClickPopup").style.display = "block";

        const cardTitle = document.getElementById("cardClickPopup-cardTitle");
        const cardDescription = document.getElementById(
          "cardClickPopup-cardDescription"
        );
        const cardImage = document.getElementById("cardClickPopup-cardImage");
        const docRef = doc(db, "database", postId);
        getDoc(docRef).then((docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            let title = data.title;
            let image = data.Image;
            let description = data.description;
            let username = data.username;

            cardImage.src = image;
            cardImage.style.maxWidth = "100%";
            cardImage.style.maxHeight = "100%";

            cardTitle.textContent = title;
            cardDescription.textContent = description;
          }
        });
      }

      function addCard(title, imageSrc, postid, isVerified) {
        const cardContainer = document.querySelector(".card-container");
        const newCard = document.createElement("div");
        newCard.classList.add("card");

        const titleElement = document.createElement("h3");
        titleElement.textContent = title;

        // Apply CSS styles to the titleElement
        titleElement.style.color = "white"; // Makes the text color white
        titleElement.style.fontSize = "16px"; // Sets the font size to 16px
        titleElement.style.marginLeft = "10px";
        titleElement.style.fontFamily = "Roboto, sans-serif";
        titleElement.style.fontWeight = "bold";
        newCard.appendChild(titleElement);
        newCard.addEventListener("click", function (event) {
          showPopup(postid);
        });

        const imgElement = document.createElement("img");
        imgElement.src = imageSrc;
        imgElement.style.width = "100%";
        imgElement.style.height = "100%";
        imgElement.style.objectFit = "cover";
        if (!isVerified) {
          imgElement.classList.add("greyed-out");
        }

        newCard.appendChild(imgElement);
        newCard.setAttribute("postid", postid);
        const addCard = document.querySelector(".add-card");
        document
          .querySelector(".card-container")
          .insertBefore(newCard, addCard);
      }

      function clearPopupFields() {
        document.getElementById("cardTitle").value = "";
        document.getElementById("cardDescription").value = "";
        document.getElementById("previewImage").style.display = "none";
        document.getElementById("previewImage").src = "";
      }

      function populateCardContainer() {
        for (const post of postIds) {
          const postRef = doc(db, "database", post);
          getDoc(postRef)
            .then((docSnap) => {
              if (docSnap.exists()) {
                const postData = docSnap.data();

                let title = postData.title;
                let image = postData.Image;
                let isVerified = postData.verified;
                if (incomingId == null || (incomingId != null && isVerified)) {
                  addCard(title, image, post, isVerified);
                }
              }
            })
            .catch((error) => {
              console.log("Error getting document:", error);
            });
        }
      }

      auth.onAuthStateChanged(function (user) {
        if (incomingId == null) {
          if (user) {
            console.log("user");
            var editb = document.getElementById("editButton");
            var logoutb = document.getElementById("logoutButton");
            var deletb = document.getElementById(
              "delete-cardClickPopup-button"
            );
            var add_card_cardContainer = document.getElementById(
              "add-card-cardContainer"
            );
            editb.style.visibility = "visible";
            logoutb.style.visibility = "visible";
            //deletb.style.visibility = "visible";
            add_card_cardContainer.style.visibility = "visible";
            uid = user.uid;
            const docRef = doc(db, "artist", uid);
            getDoc(docRef)
              .then((docSnap) => {
                if (docSnap.exists()) {
                  const data = docSnap.data();

                  username = data.username;
                  description = data.description;
                  profileImage = data.profileImage;
                  link = data.link;
                  postIds = data.posts;

                  fetch(data.profileImage)
                    .then((response) => response.blob())
                    .then((blob) => {
                      const imageUrl = URL.createObjectURL(blob);
                      document.querySelector(".profile-image").src = imageUrl;
                    })
                    .catch((error) => {
                      console.error("Error downloading profile image:", error);
                    });
                  document.querySelector(".profile-name").innerText =
                    data.username;
                  document.querySelector(".profile-description").innerText =
                    data.description;
                  document.querySelector(".profile-link").innerText = data.link;
                  populateCardContainer();
                } else {
                  alert("You have not created a profile yet");
                }
              })
              .catch((error) => {
                console.log("Error getting document:", error);
              });
          } else {
            console.log("You are not logged in");
          }
        } else {
          const docRef = doc(db, "artist", incomingId);
          getDoc(docRef)
            .then((docSnap) => {
              if (docSnap.exists()) {
                const data = docSnap.data();

                username = data.username;
                description = data.description;
                profileImage = data.profileImage;
                link = data.link;
                postIds = data.posts;

                fetch(data.profileImage)
                  .then((response) => response.blob())
                  .then((blob) => {
                    const imageUrl = URL.createObjectURL(blob);
                    document.querySelector(".profile-image").src = imageUrl;
                  })
                  .catch((error) => {
                    console.error("Error downloading profile image:", error);
                  });
                document.querySelector(".profile-name").innerText =
                  data.username;
                document.querySelector(".profile-description").innerText =
                  data.description;
                document.querySelector(".profile-link").innerText = data.link;
                populateCardContainer();
              } else {
                alert("You have not created a profile yet");
              }
            })
            .catch((error) => {
              console.log("Error getting document:", error);
            });
        }
      });
    </script>
  </body>
</html>
